<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Мой аккаунт — ЦифраМаркет</title>
  <link rel="icon" href="assets/key-icon.png" type="image/png">
  <link rel="stylesheet" href="/app/static/css/styles.css">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">
        <img src="nano-banana_20251205_181151_16c0fe00.png" alt="logo" class="logo" onerror="this.style.display='none'">
        <div>
          <h1>ЦифраМаркет</h1>
          <p class="tag">Страница аккаунта</p>
        </div>
      </div>
      <nav class="nav">
        <button onclick="location.href='/'" class="btn ghost">Главная</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="info" style="padding:12px">
      <h2>Данные аккаунта</h2>
      <div id="accountInfo" style="margin-top:12px;padding:12px;border-radius:8px;background:rgba(255,255,255,0.02)"></div>

      <h2 style="margin-top:18px">Мои заказы</h2>
      <div id="ordersList" style="margin-top:12px;display:grid;gap:12px"></div>
    </section>
  </main>

  // В account.html, замените скрипт на:

<script>
  const API_BASE_URL = 'http://localhost:8000';
  
  async function loadUserProfile() {
    try {
      const user = JSON.parse(localStorage.getItem('kv_user') || 'null');
      if (!user || !user.id) {
        document.getElementById('accountInfo').innerHTML = 
          '<div style="color:var(--muted)">Вы не вошли в аккаунт. <a href="/auth.html" style="color:var(--accent-1);">Войдите</a> или <a href="/auth.html#register" style="color:var(--accent-1);">зарегистрируйтесь</a>.</div>';
        return null;
      }
      
      // Загружаем данные пользователя с сервера
      const response = await fetch(`${API_BASE_URL}/users/${user.id}`);
      if (response.ok) {
        const userData = await response.json();
        return userData;
      } else {
        // Если не удалось загрузить с сервера, используем локальные данные
        return user;
      }
    } catch (error) {
      console.error('Ошибка загрузки профиля:', error);
      return JSON.parse(localStorage.getItem('kv_user') || 'null');
    }
  }
  
  async function renderAccountInfo() {
    const userData = await loadUserProfile();
    const info = document.getElementById('accountInfo');
    
    if (!userData) {
      info.innerHTML = '<div style="color:var(--muted)">Вы не вошли в аккаунт.</div>';
      return;
    }
    
    // Остальной код renderAccountInfo остается таким же,
    // но добавьте сохранение на сервер при обновлении данных
    
    // В обработчике saveAccount добавьте:
    document.getElementById('saveAccount').addEventListener('click', async () => {
      const newName = document.getElementById('editName').value.trim();
      const newAvatar = document.getElementById('editAvatar').value.trim();
      
      if (!newName) {
        document.getElementById('accountMsg').textContent = 'Введите имя пользователя';
        return;
      }
      
      try {
        // Обновляем на сервере
        const updatedUser = {
          name: newName,
          // Другие поля, которые можно обновить
        };
        
        const response = await fetch(`${API_BASE_URL}/users/${userData.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(updatedUser)
        });
        
        if (response.ok) {
          // Обновляем локальные данные
          const updatedData = { ...userData, name: newName, avatar: newAvatar };
          localStorage.setItem('kv_user', JSON.stringify(updatedData));
          document.getElementById('accountMsg').textContent = 'Сохранено';
          
          setTimeout(() => {
            document.getElementById('accountMsg').textContent = '';
          }, 1400);
          
          renderAccountInfo();
        }
      } catch (error) {
        document.getElementById('accountMsg').textContent = 'Ошибка сохранения';
        console.error('Ошибка обновления профиля:', error);
      }
    });
  }
  
  // Инициализация
  document.addEventListener('DOMContentLoaded', () => {
    renderAccountInfo();
    renderOrders();
  });
</script>
</body>
</html>