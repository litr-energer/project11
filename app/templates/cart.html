<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö–æ—Ä–∑–∏–Ω–∞ ‚Äî –¶–∏—Ñ—Ä–∞–ú–∞—Ä–∫–µ—Ç</title>
  <link rel="icon" href="assets/key-icon.png" type="image/png">
  <link rel="stylesheet" href="/app/static/css/styles.css">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">
        <img src="/app/static/css/Icona.png" alt="logo" class="logo" onerror="this.style.display='none'">
        <div>
          <h1>–¶–∏—Ñ—Ä–∞–ú–∞—Ä–∫–µ—Ç</h1>
          <p class="tag">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</p>
        </div>
      </div>
      <nav class="nav">
        <div id="authArea" style="display:flex;gap:8px;align-items:center">
          <div id="userProfile" style="display:none;">
            <button id="profileBtn" class="profile-btn" onclick="location.href='/account.html'">
              <div class="profile-avatar" id="userAvatar"></div>
              <span id="userName"></span>
            </button>
          </div>
          <div id="authButtons" style="display:flex;gap:8px;align-items:center">
            <button id="authBtn" class="btn ghost" onclick="location.href='/auth.html'"–ì–ü–í–æ–π—Ç–∏</button>
            <button id="registerBtn" class="btn primary" onclick="location.href='/auth.html#register'">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
          </div>
        </div>
        <button onclick="location.href='/'" class="btn ghost">–ì–ª–∞–≤–Ω–∞—è</button>
      </nav>
    </div>
  </header>

  <main class="container" style="padding-bottom:40px">
    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div id="authRequired" style="display:none; text-align:center; padding:40px;">
      <h3>–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ—Ä–∑–∏–Ω–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</h3>
      <p style="color:var(--muted); margin:10px 0 20px;">
        –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞ –≤ –∞–∫–∫–∞—É–Ω—Ç
      </p>
      <button onclick="location.href='/auth.html?redirect=/cart.html'" class="btn primary" style="margin-top:20px;">
        –í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç
      </button>
      <button onclick="location.href='/'" class="btn ghost" style="margin-top:10px;">
        –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–æ–∫—É–ø–∫–∞–º
      </button>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –∫–æ—Ä–∑–∏–Ω—ã -->
    <section id="cartSection" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <h2 style="margin:0">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h2>
        <button id="continueShopping" class="btn ghost">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏</button>
      </div>
      
      <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ -->
      <div id="cartItemsContainer" style="margin-bottom:30px">
        <!-- –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
      </div>
      
      <!-- –ò—Ç–æ–≥–æ –∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ -->
      <div id="cartSummary" style="background:rgba(255,255,255,0.02);border-radius:12px;padding:20px">
        <div style="display:flex;justify-content:space-between;margin-bottom:15px">
          <span style="color:var(--muted)"><u0421—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–æ–≤:</span>
          <span id="subtotal" style="font-weight:bold">0 ‚ÇΩ</span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:20px">
          <span style="color:var(--muted)">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</span>
          <span id="total" style="font-size:24px;font-weight:bold;color:var(--accent-1)">0 ‚ÇΩ</span>
        </div>
        
        <!-- –§–æ—Ä–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ -->
        <div id="checkoutForm" style="margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.05)">
          <h3 style="margin-bottom:15px">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h3>
          
          <div style="display:grid;gap:12px;margin-bottom:20px">
            <div>
              <label style="display:block;margin-bottom:5px;font-size:14px">–§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è *</label>
              <input id="checkoutName" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" style="width:100%;padding:10px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:var(--text)">
            </div>
            
            <div>
              <label style="display:block;margin-bottom:5px;font-size:14px">Email –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫ *</label>
              <input id="checkoutEmail" type="email" placeholder="example@email.com" style="width:100%;padding:10px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:var(--text)">
            </div>
            
            <div>
              <label style="display:block;margin-bottom:5px;font-size:14px">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã *</label>
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:5px">
                <button class="payment-method" data-method="card" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);padding:8px 12px;border-radius:8px;font-size:13px;cursor:pointer">–ö–∞—Ä—Ç–∞</button>
                <button class="payment-method" data-method="paypal" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);padding:8px 12px;border-radius:8px;font-size:13px;cursor:pointer">PayPal</button>
                <button class="payment-method" data-method="yoomoney" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);padding:8px 12px;border-radius:8px;font-size:13px;cursor:pointer">–Æ–ú–æ–Ω–µ–π</button>
                <button class="payment-method" data-method="qiwi" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);padding:8px 12px;border-radius:8px;font-size:13px;cursor:pointer">Qiwi</button>
              </div>
              <input type="hidden" id="selectedPaymentMethod" value="card">
            </div>
          </div>
          
          <div style="display:flex;gap:12px;justify-content:flex-end">
            <button id="clearCartBtn" class="btn ghost" style="padding:10px 20px">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
            <button id="checkoutBtn" class="btn primary" style="padding:12px 30px;font-size:16px">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
          </div>
        </div>
      </div>
    </section>
    
    <!-- –ü—É—Å—Ç–∞—è –∫–æ—Ä–∑–∏–Ω–∞ -->
    <div id="emptyCart" style="display:none; text-align:center; padding:60px 20px;">
      <div style="font-size:48px; margin-bottom:20px; color:var(--muted)">üõí</div>
      <h3 style="margin-bottom:10px">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h3>
      <p style="color:var(--muted); margin-bottom:30px">
        –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞, —á—Ç–æ–±—ã –æ–Ω–∏ –ø–æ—è–≤–∏–ª–∏—Å—å –∑–¥–µ—Å—å
      </p>
      <button onclick="location.href='/'" class="btn primary" style="padding:12px 30px;">
        –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–æ–≤–∞—Ä–∞–º
      </button>
    </div>
  </main>

  <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
  <div id="toast" class="toast" style="display:none"></div>

  <script>
    // –ë–∞–∑–æ–≤—ã–π URL API (–¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å app.js)
    const API_BASE_URL = '';
    
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
    let cartState = {
      items: {},
      user: null,
      subtotal: 0,
      total: 0
    };
    
    // ====================
    // –£–¢–ò–õ–ò–¢–´
    // ====================
    
    function formatPrice(price) {
      return price === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : price.toLocaleString('ru-RU') + ' ‚ÇΩ';
    }
    
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      if (!toast) return;
      
      toast.textContent = message;
      toast.className = 'toast';
      
      if (type === 'success') {
        toast.style.background = 'linear-gradient(90deg, #28a745, #20c997)';
      } else if (type === 'error') {
        toast.style.background = 'linear-gradient(90deg, #dc3545, #e83e8c)';
      } else if (type === 'info') {
        toast.style.background = 'linear-gradient(90deg, #17a2b8, #00b4d8)';
      } else {
        toast.style.background = 'linear-gradient(90deg, var(--accent-1), var(--accent-2))';
      }
      
      toast.style.display = 'block';
      
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }
    
    // ====================
    // –ü–û–õ–û–ß–ï–ù–ò–ï –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò
    // ====================
    
    function checkAuth() {
      const user = JSON.parse(localStorage.getItem('kv_user') || 'null');
      const authRequired = document.getElementById('authRequired');
      const cartSection = document.getElementById('cartSection');
      const emptyCart = document.getElementById('emptyCart');
      const authArea = document.getElementById('authArea');
      const userProfile = document.getElementById('userProfile');
      const authButtons = document.getElementById('authButtons');
      
      if (user && user.id) {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        cartState.user = user;
        
        if (authRequired) authRequired.style.display = 'none';
        if (cartSection) cartSection.style.display = 'block';
        if (userProfile) userProfile.style.display = 'flex';
        if (authButtons) authButtons.style.display = 'none';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        updateUserProfile(user);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É —Å —Å–µ—Ä–≤–µ—Ä–∞
        loadUserCart();
      } else {
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
        cartState.user = null;
        
        if (authRequired) authRequired.style.display = 'block';
        if (cartSection) cartSection.style.display = 'none';
        if (emptyCart) emptyCart.style.display = 'none';
        if (userProfile) userProfile.style.display = 'none';
        if (authButtons) authButtons.style.display = 'flex';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –∫–æ—Ä–∑–∏–Ω—É
        loadLocalCart();
      }
    }
    
    function updateUserProfile(user) {
      const userAvatar = document.getElementById('userAvatar');
      const userName = document.getElementById('userName');
      
      if (userAvatar) {
        if (user.avatar) {
          userAvatar.style.backgroundImage = `url('${user.avatar}')`;
          userAvatar.textContent = '';
        } else {
          userAvatar.style.backgroundImage = 'none';
          userAvatar.textContent = user.name.charAt(0).toUpperCase();
        }
      }
      
      if (userName) {
        userName.textContent = user.name;
      }
    }
    
    // ====================
    // API –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ö–û–†–ó–ò–ù–´
    // ====================
    
    async function loadUserCart() {
      try {
        const user = cartState.user;
        if (!user) return;
        
        console.log('–ó–∞–≥—Ä—É–∂–∞—é –∫–æ—Ä–∑–∏–Ω—É —Å –Ω–æ–≤—ã–º API endpoint–æ–º (detailed):', user.id);
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        const itemsResponse = await fetch(`${API_BASE_URL}/carts/my/items/detailed`, {
          headers: {
            'X-User-Id': user.id.toString()
          }
        });
        
        if (itemsResponse.ok) {
          const items = await itemsResponse.json();
          
          // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
          cartState.items = {};
          items.forEach(item => {
            const cartItemId = `cart-${item.id}`;
            cartState.items[cartItemId] = {
              id: cartItemId,
              api_id: item.id,
              title: item.title,
              price: item.price,
              qty: item.quantity,
              thumb: item.image_url,
              item_type: item.item_type,
              item_id: item.product_id || item.listing_id || item.author_listing_id,
              description: item.description,
              category: item.category
            };
          });
          
          updateCartDisplay();
          console.log('–ö–æ—Ä–∑–∏–Ω–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', Object.keys(cartState.items).length, '—à—Ç.');
        } else if (itemsResponse.status === 401) {
          console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
          loadLocalCart();
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∂–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã:', error);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –∫–æ—Ä–∑–∏–Ω—É –∫–∞–∫ fallback
        loadLocalCart();
      }
    }
    
    async function updateCartItemQuantityAPI(cartItemId, newQty) {
      try {
        const user = cartState.user;
        if (!user) return { success: false };
        
        const cartItem = cartState.items[cartItemId];
        if (!cartItem || !cartItem.api_id) {
          console.warn('API ID –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è:', cartItemId);
          return { success: false };
        }
        
        const response = await fetch(`${API_BASE_URL}/carts/my/items/${cartItem.api_id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-User-Id': user.id.toString()
          },
          body: JSON.stringify({ quantity: newQty })
        });
        
        if (response.ok) {
          return { success: true };
        } else {
          const errorData = await response.json();
          throw new Error(errorData.detail || `–û—à–∏–±–∫–∞: ${response.status}`);
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞:', error);
        return { success: false, error: error.message };
      }
    }
    
    async function removeItemFromCartAPI(cartItemId) {
      try {
        const user = cartState.user;
        if (!user) return { success: false };
        
        const cartItem = cartState.items[cartItemId];
        if (!cartItem || !cartItem.api_id) {
          console.warn('API ID –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è:', cartItemId);
          return { success: false };
        }
        
        const response = await fetch(`${API_BASE_URL}/carts/my/items/${cartItem.api_id}`, {
          method: 'DELETE',
          headers: {
            'X-User-Id': user.id.toString()
          }
        });
        
        if (response.ok) {
          return { success: true };
        } else {
          const errorData = await response.json();
          throw new Error(errorData.detail || `–û—à–∏–±–∫–∞: ${response.status}`);
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã:', error);
        return { success: false, error: error.message };
      }
    }
    
    async function clearCartAPI() {
      try {
        const user = cartState.user;
        if (!user) return { success: false };
        
        const response = await fetch(`${API_BASE_URL}/carts/my/clear`, {
          method: 'DELETE',
          headers: {
            'X-User-Id': user.id.toString()
          }
        });
        
        if (response.ok) {
          return { success: true };
        } else {
          const errorData = await response.json();
          throw new Error(errorData.detail || `–û—à–∏–±–∫–∞: ${response.status}`);
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã:', error);
        return { success: false, error: error.message };
      }
    }
    
    // ====================
    // –õ–û–ö–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ö–û–†–ó–ò–ù–´
    // ====================
    
    function loadLocalCart() {
      try {
        const cart = JSON.parse(localStorage.getItem('kv_cart') || '{}');
        cartState.items = cart;
        updateCartDisplay();
        console.log('–õ–æ–∫–∞–ª—å–Ω–∞—è –∫–æ—Ä–∑–∏–Ω–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', Object.keys(cartState.items).length, '—à—Ç.');
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∂–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ–π –∫–æ—Ä–∑–∏–Ω—ã:', error);
        cartState.items = {};
        updateCartDisplay();
      }
    }
    
    function saveLocalCart() {
      localStorage.setItem('kv_cart', JSON.stringify(cartState.items));
    }
    
    function removeFromCart(cartItemId) {
      if (cartState.items[cartItemId]) {
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, —É–¥–∞–ª—è–µ–º –∏–∑ API
        if (cartState.user) {
          removeItemFromCartAPI(cartItemId);
        }
        
        delete cartState.items[cartItemId];
        
        if (!cartState.user) {
          saveLocalCart();
        }
        
        updateCartDisplay();
        showToast('–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã', 'info');
      }
    }
    
    function updateCartQuantity(cartItemId, newQty) {
      if (cartState.items[cartItemId]) {
        if (newQty <= 0) {
          removeFromCart(cartItemId);
        } else {
          // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –æ–±–Ω–æ–≤–ª—è–µ–º –≤ API
          if (cartState.user) {
            updateCartItemQuantityAPI(cartItemId, newQty);
          }
          
          cartState.items[cartItemId].qty = newQty;
          
          if (!cartState.user) {
            saveLocalCart();
          }
          
          updateCartDisplay();
        }
      }
    }
    
    function clearCart() {
      if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?')) {
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –æ—á–∏—â–∞–µ–º –≤ API
        if (cartState.user) {
          clearCartAPI();
        }
        
        cartState.items = {};
        
        if (!cartState.user) {
          saveLocalCart();
        }
        
        updateCartDisplay();
        showToast('–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞', 'info');
      }
    }
    
    function getCartTotal() {
      return Object.values(cartState.items).reduce((total, item) => {
        return total + (item.price * item.qty);
      }, 0);
    }
    
    // ====================
    // –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ö–û–†–ó–ò–ù–´
    // ====================
    
    function updateCartDisplay() {
      const items = Object.values(cartState.items);
      const cartItemsContainer = document.getElementById('cartItemsContainer');
      const emptyCart = document.getElementById('emptyCart');
      const cartSection = document.getElementById('cartSection');
      const subtotalEl = document.getElementById('subtotal');
      const totalEl = document.getElementById('total');
      
      if (items.length === 0) {
        // –ü—É—Å—Ç–∞—è –∫–æ—Ä–∑–∏–Ω–∞
        if (cartItemsContainer) cartItemsContainer.innerHTML = '';
        if (emptyCart) emptyCart.style.display = 'block';
        if (cartSection) cartSection.style.display = 'none';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏
        if (subtotalEl) subtotalEl.textContent = '0 ‚ÇΩ';
        if (totalEl) totalEl.textContent = '0 ‚ÇΩ';
        
        return;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
      if (emptyCart) emptyCart.style.display = 'none';
      if (cartSection) cartSection.style.display = 'block';
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã
      if (cartItemsContainer) {
        cartItemsContainer.innerHTML = items.map(item => `
          <div class="cart-item" style="display:flex;gap:15px;padding:15px;background:rgba(255,255,255,0.02);border-radius:10px;margin-bottom:10px">
            <div style="width:80px;height:80px;border-radius:6px;overflow:hidden;flex-shrink:0">
              <img src="${item.thumb}" alt="${item.title}" style="width:100%;height:100%;object-fit:cover">
            </div>
            <div style="flex:1">
              <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                <div style="flex:1;padding-right:15px">
                  <h4 style="margin:0;font-size:16px">${item.title}</h4>
                  <p style="color:var(--muted);font-size:12px;margin:3px 0 0 0">${item.category}</p>
                </div>
                <span style="font-weight:bold;font-size:16px;white-space:nowrap">${formatPrice(item.price)}</span>
              </div>
              ${item.description ? `<p style="color:var(--muted);font-size:13px;margin:0 0 10px 0">${item.description}</p>` : ''}
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="display:flex;align-items:center;gap:10px">
                  <button class="qty-btn" data-action="decrease" data-id="${item.id}" style="width:30px;height:30px;border-radius:50%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:var(--text);cursor:pointer;font-weight:bold">‚àí</button>
                  <span style="font-weight:bold;min-width:30px;text-align:center">${item.qty} —à—Ç.</span>
                  <button class="qty-btn" data-action="increase" data-id="${item.id}" style="width:30px;height:30px;border-radius:50%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:var(--text);cursor:pointer;font-weight:bold">+</button>
                </div>
                <button class="remove-btn" data-action="remove" data-id="${item.id}" style="background:none;border:none;color:var(--muted);font-size:13px;cursor:pointer;text-decoration:underline">–£–¥–∞–ª–∏—Ç—å</button>
              </div>
            </div>
          </div>
        `).join('');
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏
      const subtotal = getCartTotal();
      const total = subtotal; // –ú–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ –∏ –Ω–∞–ª–æ–≥–∏
      
      if (subtotalEl) subtotalEl.textContent = formatPrice(subtotal);
      if (totalEl) totalEl.textContent = formatPrice(total);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      setupCartEventListeners();
    }
    
    // ====================
    // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô
    // ====================
    
    function setupCartEventListeners() {
      // –ö–Ω–æ–ø–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
      document.querySelectorAll('.qty-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const action = e.target.dataset.action;
          const itemId = e.target.dataset.id;
          const item = cartState.items[itemId];
          
          if (!item) return;
          
          if (action === 'increase') {
            updateCartQuantity(itemId, item.qty + 1);
          } else if (action === 'decrease') {
            updateCartQuantity(itemId, item.qty - 1);
          }
        });
      });
      
      // –ö–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
      document.querySelectorAll('.remove-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const itemId = e.target.dataset.id;
          removeFromCart(itemId);
        });
      });
    }
    
    function setupPageEventListeners() {
      // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏"
      const continueShopping = document.getElementById('continueShopping');
      if (continueShopping) {
        continueShopping.addEventListener('click', () => {
          window.location.href = '/';
        });
      }
      
      // –ö–Ω–æ–ø–∫–∞ "–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É"
      const clearCartBtn = document.getElementById('clearCartBtn');
      if (clearCartBtn) {
        clearCartBtn.addEventListener('click', clearCart);
      }
      
      // –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
      document.querySelectorAll('.payment-method').forEach(button => {
        button.addEventListener('click', (e) => {
          const method = e.target.dataset.method;
          
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª—å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
          document.querySelectorAll('.payment-method').forEach(btn => {
            btn.style.background = 'rgba(255,255,255,0.05)';
            btn.style.border = '1px solid rgba(255,255,255,0.1)';
          });
          
          // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
          e.target.style.background = 'rgba(43, 92, 255, 0.2)';
          e.target.style.border = '1px solid rgba(43, 92, 255, 0.5)';
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä
          document.getElementById('selectedPaymentMethod').value = method;
        });
      });
      
      // –ö–Ω–æ–ø–∫–∞ "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑"
      const checkoutBtn = document.getElementById('checkoutBtn');
      if (checkoutBtn) {
        checkoutBtn.addEventListener('click', () => {
          const name = document.getElementById('checkoutName').value.trim();
          const email = document.getElementById('checkoutEmail').value.trim();
          const paymentMethod = document.getElementById('selectedPaymentMethod').value;
          
          if (!name || !email) {
            showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
            return;
          }
          
          if (Object.keys(cartState.items).length === 0) {
            showToast('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞', 'error');
            return;
          }
          
          // –°–∏–º—É–ª—è—Ü–∏—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
          checkoutBtn.disabled = true;
          checkoutBtn.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
          
          setTimeout(() => {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–∫–∞–∑
            const order = {
              id: 'ord-' + Date.now(),
              user: cartState.user ? cartState.user.name : name,
              name,
              email,
              method: paymentMethod,
              items: Object.values(cartState.items),
              total: getCartTotal(),
              created_at: new Date().toISOString()
            };
            
            const orders = JSON.parse(localStorage.getItem('kv_orders') || '[]');
            orders.unshift(order);
            localStorage.setItem('kv_orders', JSON.stringify(orders));
            
            // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
            clearCart();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            showToast(`–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –°—Å—ã–ª–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ ${email}`, 'success');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            checkoutBtn.disabled = false;
            checkoutBtn.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('checkoutName').value = '';
            document.getElementById('checkoutEmail').value = '';
  
          }, 1500);
        });
      }
    }
    
    // ====================
    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ô
    // ====================
    
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      setupPageEventListeners();
      
      // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      const firstPaymentMethod = document.querySelector('.payment-method');
      if (firstPaymentMethod) {
        firstPaymentMethod.click();
      }
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ localStorage
    window.addEventListener('storage', () => {
      checkAuth();
    });
  </script>
</body>
</html>